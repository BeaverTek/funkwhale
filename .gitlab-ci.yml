image: docker:latest

stages:
  - build
  - test

test_api:
  stage: test
  before_script:
    - docker-compose -f api/test.yml build
  script:
    - docker-compose -f api/test.yml run test
  after_script:
    - docker-compose -f api/test.yml run rm -rf api/funkwhale_api/media/*

  tags:
    - dind

build_front:
  stage: build
  before_script:
    - docker-compose -f dev.yml run front rm dist/*
    - docker-compose -f dev.yml build front
  script:
    - docker-compose -f dev.yml run front npm run build
  artifacts:
    paths:
      - front/dist
  only:
    - master
    - develop
  tags:
    - dind
# When using dind, it's wise to use the overlayfs driver for
# improved performance.
# variables:
#   DOCKER_DRIVER: overlay
#
# services:
# - docker:dind
#
#
# # build:
# #   stage: build
# #   script:
# #   - docker login -u="$DOCKER_USERNAME" -p="$DOCKER_PASSWORD"
# #   - docker build -t funkwhale/front .
# #   - docker push
# #
# #   tags:
# #     - dind
# #   only:
# #     - master
