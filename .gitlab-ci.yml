stages:
  - test
  - build

test_api:
  stage: test
  before_script:
    - docker-compose -f api/test.yml build
  script:
    - docker-compose -f api/test.yml run test
  after_script:
    - docker-compose -f api/test.yml run test rm -rf api/funkwhale_api/media/*

  tags:
    - dind

build_front:
  stage: build
  image: node:6-alpine
  before_script:
    - cd front

  script:
    - npm install
    - npm run build
  cache:
    key: "$CI_COMMIT_REF_NAME"
    paths:
      - front/node_modules
  artifacts:
    name: "front_${CI_COMMIT_REF_NAME}"
    paths:
      - front/dist/
  only:
    - master
    - develop
  tags:
    - docker


# When using dind, it's wise to use the overlayfs driver for
# improved performance.
# variables:
#   DOCKER_DRIVER: overlay
#
# services:
# - docker:dind
#
#
# # build:
# #   stage: build
# #   script:
# #   - docker login -u="$DOCKER_USERNAME" -p="$DOCKER_PASSWORD"
# #   - docker build -t funkwhale/front .
# #   - docker push
# #
# #   tags:
# #     - dind
# #   only:
# #     - master
